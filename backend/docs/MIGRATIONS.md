# Migration Quick Reference

## Migration Dependency Chain

```
001_add_user_model
    ↓
002_create_kits
    ↓
003_create_custody_events
    ↓
004_create_approval_requests
    ↓
005_add_attestation_fields
    ↓
006_create_maintenance_events
    ↓
007_convert_user_role_to_enum
    ↓
008_add_expected_return_date
    ↓
009_add_performance_indexes
```

## What Each Migration Does

### 001_add_user_model
- Creates `users` table
- Adds OAuth authentication fields (email, oauth_provider, oauth_id)
- Adds role field (initially as String)
- Adds verified_adult and is_active flags
- Creates indexes on id, email (unique), oauth_id

### 002_create_kits
- Creates `kits` table
- Adds QR code field (unique)
- Adds kit status enum (available, checked_out, in_maintenance, lost)
- Adds current custodian tracking
- Creates indexes on id, code (unique)

### 003_create_custody_events
- Creates `custody_events` table (immutable audit log)
- Adds event type enum (checkout_onprem, checkout_offsite, checkin, transfer, lost, found)
- Adds foreign keys to kits and users
- Tracks initiator and custodian
- Creates indexes on id, kit_id

### 004_create_approval_requests
- Creates `approval_requests` table
- Adds approval status enum (pending, approved, denied)
- Tracks requester, custodian, and approver
- Adds notes and denial reason fields
- Creates indexes on id, kit_id

### 005_add_attestation_fields
- Adds responsibility attestation fields to approval_requests
- Adds attestation_text, attestation_signature
- Adds attestation_timestamp and attestation_ip_address for audit trail

### 006_create_maintenance_events
- Creates `maintenance_events` table
- Tracks open/close maintenance workflow
- Adds opened_by and closed_by user tracking
- Adds notes, parts_replaced, round_count fields
- Adds is_open boolean flag
- Creates indexes on id, kit_id

### 007_convert_user_role_to_enum
- Creates UserRole PostgreSQL enum type
- Converts users.role from String to UserRole enum
- Improves type safety and validation

### 008_add_expected_return_date
- Adds expected_return_date field to custody_events
- Adds expected_return_date field to approval_requests
- Enables soft warnings for overdue returns

### 009_add_performance_indexes
- Adds index on approval_requests.status
- Adds index on maintenance_events.is_open
- Adds index on custody_events.event_type
- Adds index on users.role
- Adds composite index on custody_events(kit_id, created_at)

## Common Migration Commands

```bash
# Check current migration status
alembic current

# View migration history
alembic history --verbose

# Apply all migrations
alembic upgrade head

# Apply specific migration
alembic upgrade 005_add_attestation_fields

# Rollback one migration
alembic downgrade -1

# Rollback to specific revision
alembic downgrade 003_create_custody_events

# Generate new migration from model changes
alembic revision --autogenerate -m "description"

# Create empty migration template
alembic revision -m "description"
```

## Migration Best Practices

1. **Always backup database before migrations**
2. **Test migrations on development environment first**
3. **Review autogenerated migrations before applying**
4. **Include both upgrade() and downgrade() functions**
5. **Use descriptive migration messages**
6. **Don't edit applied migrations - create new ones**
7. **Add comments for complex migrations**
8. **Test rollback (downgrade) functionality**

## Troubleshooting

### Migration conflicts
If you see "Conflicting revisions" error:
```bash
# View all current heads
alembic heads

# Merge conflicting branches
alembic merge -m "merge branches" <rev1> <rev2>
```

### Database out of sync
If database doesn't match migrations:
```bash
# Stamp database to specific revision without running migrations
alembic stamp <revision_id>
```

### Reset migration history (DANGER - development only)
```bash
# Drop all tables
alembic downgrade base

# Reapply all migrations
alembic upgrade head
```
